<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 영화 평점 아카이브</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <h1 class="logo">
                <i class="fas fa-film"></i>
                Movie Archive
            </h1>
            <nav class="nav">
                <a href="#search-section">검색</a>
                <a href="#my-ratings">내 평점</a>
                <div id="auth-section" class="auth-section">
                    <div id="user-info" class="user-info hidden" style="display: none;">
                        <img id="user-avatar" class="user-avatar" src="" alt="프로필">
                        <span id="user-name" class="user-name"></span>
                        <button id="logout-btn" class="logout-btn">로그아웃</button>
                    </div>
                    <button id="login-btn" class="login-btn" style="display: flex;">
                        <i class="fas fa-user"></i>
                        로그인
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <main class="main-container">
        <!-- 검색 섹션 -->
        <section id="search-section" class="search-section">
            <div class="container">
                <h2>영화 검색</h2>
                <div class="search-box">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="영화 제목을 입력하세요..."
                        autocomplete="off"
                    >
                    <button id="search-btn" type="button">
                        <i class="fas fa-search"></i>
                        검색
                    </button>
                </div>
                
                <!-- 고급 검색 필터 -->
                <div class="search-filters">
                    <button id="toggle-filters" class="filter-toggle">
                        <i class="fas fa-filter"></i>
                        고급 필터
                    </button>
                    
                    <div id="filter-panel" class="filter-panel hidden">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="genre-filter">장르</label>
                                <select id="genre-filter">
                                    <option value="">모든 장르</option>
                                    <option value="28">액션</option>
                                    <option value="12">모험</option>
                                    <option value="16">애니메이션</option>
                                    <option value="35">코미디</option>
                                    <option value="80">범죄</option>
                                    <option value="99">다큐멘터리</option>
                                    <option value="18">드라마</option>
                                    <option value="10751">가족</option>
                                    <option value="14">판타지</option>
                                    <option value="36">역사</option>
                                    <option value="27">공포</option>
                                    <option value="10402">음악</option>
                                    <option value="9648">미스터리</option>
                                    <option value="10749">로맨스</option>
                                    <option value="878">SF</option>
                                    <option value="10770">TV 영화</option>
                                    <option value="53">스릴러</option>
                                    <option value="10752">전쟁</option>
                                    <option value="37">서부</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="year-filter">연도</label>
                                <select id="year-filter">
                                    <option value="">모든 연도</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="2019">2019</option>
                                    <option value="2018">2018</option>
                                    <option value="2017">2017</option>
                                    <option value="2016">2016</option>
                                    <option value="2015">2015</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="sort-filter">정렬</label>
                                <select id="sort-filter">
                                    <option value="popularity.desc">인기순</option>
                                    <option value="release_date.desc">최신순</option>
                                    <option value="release_date.asc">오래된순</option>
                                    <option value="vote_average.desc">평점 높은순</option>
                                    <option value="vote_average.asc">평점 낮은순</option>
                                    <option value="title.asc">제목순 (A-Z)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-actions">
                            <button id="apply-filters" class="apply-btn">
                                <i class="fas fa-check"></i>
                                필터 적용
                            </button>
                            <button id="reset-filters" class="reset-btn">
                                <i class="fas fa-undo"></i>
                                초기화
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 로딩 스피너 -->
                <div id="loading" class="loading hidden">
                    <i class="fas fa-spinner fa-spin"></i>
                    검색 중...
                </div>
            </div>
        </section>

        <!-- 검색 결과 섹션 -->
        <section id="search-results" class="search-results">
            <div class="container">
                <div id="results-container" class="results-container">
                    <!-- 검색 결과가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </section>

        <!-- 영화 상세 정보 모달 -->
        <div id="movie-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn" id="close-modal" title="닫기">
                    <i class="fas fa-times"></i>
                </span>
                <div id="movie-details" class="movie-details">
                    <!-- 영화 상세 정보가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>

        <!-- 로그인 모달 -->
        <div id="login-modal" class="modal hidden">
            <div class="modal-content login-modal-content">
                <span class="close-btn" id="close-login-modal" title="닫기">
                    <i class="fas fa-times"></i>
                </span>
                <div class="login-container">
                    <h2 class="login-title">
                        <i class="fas fa-film"></i>
                        Movie Archive 로그인
                    </h2>
                    <p class="login-subtitle">개인 평점을 저장하고 관리하세요</p>
                    
                    <!-- 구글 로그인 -->
                    <button id="google-login-btn" class="social-login-btn google-btn" onclick="handleGoogleLogin();">
                        <i class="fab fa-google"></i>
                        Google로 로그인
                    </button>
                    
                    <div class="divider">
                        <span>또는</span>
                    </div>
                    
                    <!-- 이메일 로그인 폼 -->
                    <div id="email-login-form" class="email-form">
                        <div class="form-group">
                            <input type="email" id="email-input" placeholder="이메일 주소" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="password-input" placeholder="비밀번호" required>
                        </div>
                        <button id="email-login-btn" class="email-login-btn" onclick="handleEmailLogin()">
                            <i class="fas fa-envelope"></i>
                            이메일로 로그인
                        </button>
                        
                        <div class="forgot-password">
                            <button id="forgot-password-btn" class="forgot-password-btn" onclick="showPasswordResetForm()">
                                비밀번호를 잊으셨나요?
                            </button>
                        </div>
                    </div>
                    
                    <div class="auth-switch">
                        <p id="auth-switch-text">계정이 없으신가요? 
                            <button id="switch-to-signup" class="switch-btn">회원가입</button>
                        </p>
                    </div>
                    
                    <!-- 비밀번호 재설정 폼 (숨김 상태) -->
                    <div id="password-reset-form" class="email-form hidden">
                        <h3 class="reset-title">비밀번호 재설정</h3>
                        <p class="reset-description">가입하신 이메일 주소를 입력하시면 비밀번호 재설정 링크를 보내드립니다.</p>
                        <div class="form-group">
                            <input type="email" id="reset-email-input" placeholder="이메일 주소" required>
                        </div>
                        <button id="send-reset-btn" class="email-login-btn" onclick="handlePasswordReset()">
                            <i class="fas fa-paper-plane"></i>
                            재설정 이메일 발송
                        </button>
                        <button id="back-to-login-btn" class="back-btn" onclick="hidePasswordResetForm()">
                            <i class="fas fa-arrow-left"></i>
                            로그인으로 돌아가기
                        </button>
                    </div>
                    
                    <!-- 회원가입 폼 (숨김 상태) -->
                    <div id="email-signup-form" class="email-form hidden">
                        <div class="form-group">
                            <input type="text" id="signup-name-input" placeholder="이름" required>
                        </div>
                        <div class="form-group">
                            <input type="email" id="signup-email-input" placeholder="이메일 주소" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="signup-password-input" placeholder="비밀번호 (6자 이상)" required>
                        </div>
                        <button id="email-signup-btn" class="email-login-btn" onclick="handleEmailSignup()">
                            <i class="fas fa-user-plus"></i>
                            계정 만들기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 비밀번호 변경 모달 -->
        <div id="password-change-modal" class="modal hidden">
            <div class="modal-content login-modal-content">
                <span class="close-btn" id="close-password-change-modal" title="닫기">
                    <i class="fas fa-times"></i>
                </span>
                <div class="login-container">
                    <h2 class="login-title">
                        <i class="fas fa-key"></i>
                        비밀번호 변경
                    </h2>
                    <p class="login-subtitle">새로운 비밀번호를 입력해주세요 (최소 6자 이상)</p>
                    
                    <form id="password-change-form" class="auth-form">
                        <div class="input-group">
                            <label for="new-password">
                                <i class="fas fa-lock"></i>
                                새 비밀번호
                            </label>
                            <input type="password" id="new-password" name="new-password" required 
                                   minlength="6" placeholder="최소 6자 이상 입력">
                        </div>
                        <div class="input-group">
                            <label for="confirm-password">
                                <i class="fas fa-lock"></i>
                                비밀번호 확인
                            </label>
                            <input type="password" id="confirm-password" name="confirm-password" required 
                                   minlength="6" placeholder="비밀번호를 다시 입력">
                        </div>
                        <div id="password-match-message" class="password-match-message" style="display: none;"></div>
                        <button type="submit" id="change-password-btn" class="email-login-btn">
                            <i class="fas fa-save"></i>
                            비밀번호 변경
                        </button>
                        <button type="button" id="cancel-password-change" class="cancel-btn" onclick="hidePasswordChangeModal()">
                            <i class="fas fa-times"></i>
                            취소
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 내 평점 섹션 -->
        <section id="my-ratings" class="my-ratings">
            <div class="container">
                <h2>내가 평가한 영화들</h2>
                <div id="rated-movies" class="rated-movies-container">
                    <!-- 평가한 영화들이 여기에 표시됩니다 -->
                </div>
            </div>
        </section>
    </main>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Movie Archive. Powered by TMDB API</p>
        </div>
    </footer>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- JavaScript 파일 -->
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    
    <!-- Supabase 초기화 확인 스크립트 -->
    <script>
        // 기본 JavaScript 작동 확인
        alert('JavaScript 로딩됨!');
        
        // Supabase SDK 로딩 확인
        alert('Supabase SDK 확인:\n' + 
              'supabase 전역 객체: ' + (typeof supabase !== 'undefined') + '\n' +
              'createClient: ' + (typeof supabase?.createClient !== 'undefined'));
        
        // Supabase 로딩 확인
        window.addEventListener('load', function() {
            alert('페이지 로드 완료!');
            
            // URL 파라미터 확인 (OAuth 리디렉션 후)
            const urlParams = new URLSearchParams(window.location.search);
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            
            alert('URL 확인:\n' + 
                  'search: ' + window.location.search + '\n' +
                  'hash: ' + window.location.hash + '\n' +
                  'access_token: ' + (fragment.get('access_token') ? '있음' : '없음'));
            
            // OAuth 토큰이 있으면 강제로 세션 새로고침
            if (fragment.get('access_token')) {
                alert('OAuth 토큰 발견! 세션 새로고침 시도...');
                
                // 로그인 모달 즉시 닫기
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.classList.add('hidden');
                    alert('로그인 모달 강제로 닫음');
                }
                
                // Supabase가 URL 해시를 처리하도록 강제
                if (typeof supabaseClient !== 'undefined' && supabaseClient.auth) {
                    // 토큰을 직접 설정
                    const accessToken = fragment.get('access_token');
                    const refreshToken = fragment.get('refresh_token');
                    
                    alert('토큰 정보:\naccess_token: ' + (accessToken ? '있음' : '없음') + 
                          '\nrefresh_token: ' + (refreshToken ? '있음' : '없음'));
                    
                    // setSession 대신 다른 방법 시도
                    alert('다른 방법으로 로그인 처리 시도...');
                    
                    // 1. 먼저 현재 세션 확인
                    supabaseClient.auth.getSession().then(({ data: sessionData, error: sessionError }) => {
                        alert('현재 세션 확인:\n' + 
                              '세션: ' + (sessionData.session ? '있음' : '없음') + '\n' +
                              '사용자: ' + (sessionData.session?.user?.email || '없음') + '\n' +
                              '에러: ' + (sessionError ? sessionError.message : '없음'));
                        
                        if (sessionData.session && sessionData.session.user) {
                            // 이미 세션이 있으면 UI 업데이트
                            alert('기존 세션 발견! 로그인 처리...');
                            updateLoginUI(sessionData.session.user);
                        } else {
                            // 세션이 없으면 URL 해시를 그대로 두고 페이지 새로고침
                            alert('세션이 없습니다. Supabase가 자동으로 처리하도록 새로고침...');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    }).catch(err => {
                        alert('세션 확인 오류: ' + err.message);
                    });
                    
                    // UI 업데이트 함수
                    function updateLoginUI(user) {
                        alert('UI 업데이트 시작: ' + user.email);
                        
                        // URL 해시 제거
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // UI 요소들 직접 업데이트
                        const loginBtn = document.getElementById('login-btn');
                        const userInfo = document.getElementById('user-info');
                        const userName = document.getElementById('user-name');
                        const logoutBtn = document.getElementById('logout-btn');
                        
                        if (loginBtn) {
                            loginBtn.style.display = 'none';
                            alert('로그인 버튼 숨김');
                        }
                        if (userInfo) {
                            userInfo.style.display = 'flex';
                            alert('사용자 정보 표시');
                        }
                        if (userName) {
                            userName.textContent = user.email;
                            alert('사용자 이름 설정: ' + user.email);
                        }
                        if (logoutBtn) {
                            logoutBtn.style.display = 'flex';
                            alert('로그아웃 버튼 표시');
                        }
                    }
                }
            }
            
            console.log('Supabase 사용 가능:', typeof supabase !== 'undefined');
            console.log('현재 도메인:', window.location.hostname);
            
            // 함수 존재 여부 확인
            alert('handleGoogleLogin: ' + typeof handleGoogleLogin + '\nsignInWithGoogle: ' + typeof signInWithGoogle);
            
            // 구글 로그인 버튼에 직접 이벤트 리스너 추가
            const googleBtn = document.getElementById('google-login-btn');
            if (googleBtn) {
                alert('구글 로그인 버튼 찾음!');
                googleBtn.addEventListener('click', function(e) {
                    alert('구글 로그인 버튼 클릭됨!');
                    e.preventDefault();
                    if (typeof handleGoogleLogin === 'function') {
                        handleGoogleLogin();
                    } else {
                        alert('handleGoogleLogin 함수를 찾을 수 없음');
                    }
                });
            } else {
                alert('구글 로그인 버튼을 찾을 수 없음');
            }
        });
    </script>
</body>
</html>
